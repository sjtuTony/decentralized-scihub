on:
  pull_request:
    paths:
      - 'papers/**'
    branchs:
      - main

jobs:
  file_info:
    runs-on: ubuntu-latest
    needs: changefiles
    outputs:
      cid: ${{ steps._getcid.outputs.cid }}
      cidLength: ${{ steps._getcid.outputs.cidLength }}
      size: ${{ steps._getcid.outputs.size }}
    steps:
      - uses: actions/checkout@v1
      - id: _getcid
        run: |
          chmod +x ".github/etc/getInfo.sh"
          chmod +x ".github/etc/jq"
          files=$(git diff --name-only --diff-filter=ACM ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | xargs)
          #info=$(./.github/etc/getInfo.sh "${{ needs.changefiles.outputs.files }}")
          info=$(./.github/etc/getInfo.sh "$files")
          cid=$(echo $info | .github/etc/jq -r .cid)
          cidLength=$(echo $cid | awk '{print length}')
          size=$(echo $info | .github/etc/jq -r .size)
          echo "cid:$cid, length:$cidLength, size:$size"
          echo "::set-output name=cid::$cid"
          echo "::set-output name=cidLength::$cidLength"
          echo "::set-output name=size::$size"
    #changefiles:
    #  runs-on: ubuntu-latest
    #  outputs:
    #    files: ${{ steps.getchangefiles.outputs.files }}
    #  steps:
    #    - uses: actions/checkout@v1
    #    - id: getchangefiles
    #      run: echo "::set-output name=files::$(git diff --name-only --diff-filter=ACM ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | xargs)"


  upload_sci_doc:
    name: Upload SCI doc
    runs-on: ubuntu-latest
    needs: file_info
    if: ${{ needs.file_info.outputs.cidLength }} == 46
    steps:
      - uses: crustio/ipfs-crust-action@v2.0.4
        timeout-minutes: 15
        with:
          cid: ${{ needs.file_info.outputs.cid }}
          size: ${{ needs.file_info.outputs.size }}
          seeds: ${{ secrets.CRUST_SEEDS }}
      - uses: actions/checkout@v2.1.0
      - name: Crust replicas action
        id: replica
        uses: TonyCode2012/crust-replicas-action@v1.0.0
        with:
          cid: ${{ needs.file_info.outputs.cid }}
          crust-endpoint: 'wss://rpc.crust.network'
          max-attempts: 2
      - name: Get file replica
        run: |
            if [ x"${{ steps.replica.outputs.replicaCount }}" = x"0" ]; then
                echo "Upload papers failed!"
            else
                echo "Upload papers successfully! Replica: ${{ steps.replica.outputs.replicaCount }}"
            fi
