on:
  pull_request:
    branchs:
      - main

jobs:
  uploadcid:
    runs-on: ubuntu-latest
    outputs:
      cid: ${{ steps.getcid.outputs.cid }}
      cidlength: ${{ steps.getcidlength.outputs.length }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - id: getcid
        run: |
          echo "::set-output name=cid::$(git status -s)"
          echo "cid:$(./.github/workflows/etc/getcid.sh)"
          gsha=$(git log -1 --format='%H'); echo "status:$(git diff --name-only --diff-filter=ACMRT ${{ github.event.pull_request.base.sha }} $gsha )"
          #echo "status:$(git diff --name-only --diff-filter=ACMRT ${{ github.event.pull_request.base.sha }} ${{ github.sha }})"
      - id: getcidlength
        run: echo "::set-output name=cidlength::$( echo $CID | awk '{print length}')"

  upload_sci_doc:
    name: Upload SCI doc
    runs-on: ubuntu-latest
    needs: uploadcid
    if: ${{ needs.uploadcid.outputs.cidlength == 46 }}
    steps:
      - uses: crustio/ipfs-crust-action@v1.0.8
        with:
          cid: ${{ needs.uploadcid.outputs.cid }}
          seeds: ${{ secrets.CRUST_SEEDS }}
